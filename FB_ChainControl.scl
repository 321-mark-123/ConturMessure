FUNCTION_BLOCK "FB_ChainControl"
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// DEPRECATED / LEGACY
// Please use "FB_MainChain" instead. This block is for reference only.
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
{ S7_Optimized_Access := 'TRUE' }
VERSION: 0.1
   VAR_INPUT
      bBtnGreen: BOOL;
      bBtnRed: BOOL;
      bKeySwitch: BOOL;
      bIniMessungStart: BOOL;
      bStation1_Occupied: BOOL;
      bStation2_Arrival: BOOL;
      bStation3_Arrival: BOOL;
      i_Meas_X_Right: DINT;
      i_Meas_X_Left: DINT;
      i_Meas_Y_Vertical: DINT;
      i_Clock_1Hz: BOOL;
      b_Reset : BOOL;
      b_enable : BOOL;
   END_VAR

   VAR_OUTPUT
      bLightRed: BOOL;
      bLightGreen: BOOL;
      bHornAlarm: BOOL;
      bPrgrReadyForRobot: BOOL;
      nPrgrNr_Robot: DINT;
   END_VAR

   VAR
      step_St2: INT;
      step_St3: INT;
      tempIndex: INT;
      bFound: BOOL;
      
      trig_St2_Arr: R_TRIG;
      trig_St3_Arr: R_TRIG;
      
      trig_BtnGreen: R_TRIG;
      trig_BtnRed: R_TRIG;
      trig_MeasStart: R_TRIG;
      
      timer_Teach: TON;
      
      bFlash: BOOL;
   END_VAR

BEGIN
   // -------------------------------------------------------------
   // TRIGGER & CLOCK
   // -------------------------------------------------------------
   #trig_St2_Arr(CLK := #bStation2_Arrival);
   #trig_St3_Arr(CLK := #bStation3_Arrival);
   
   #trig_BtnGreen(CLK := #bBtnGreen);
   #trig_BtnRed(CLK := #bBtnRed);
   #trig_MeasStart(CLK := #bIniMessungStart);
   
   // Fake Flasher
   #bFlash := #i_Clock_1Hz;

   // -------------------------------------------------------------
   // STATION 2: Check & Teach-In
   // -------------------------------------------------------------
   // Step 4: Arrival St2
   IF #trig_St2_Arr.Q THEN
       "KetteLaufwagenDB".Station2 := "KetteLaufwagenDB".Station1;
       "KetteLaufwagenDB".Station1.nArticleNumber := 0; // Clear Prev
       #step_St2 := 0;
   END_IF;

   CASE #step_St2 OF
       0: // Idle / Analysis
          IF "KetteLaufwagenDB".Station2.nArticleNumber > 0 THEN
               // Check DB for Article
               #bFound := FALSE;
               FOR #tempIndex := 0 TO 999 DO
                   IF "MaximalkonturDB".Articles[#tempIndex].nArticleNumber = "KetteLaufwagenDB".Station2.nArticleNumber THEN
                       #bFound := TRUE;
                       // Load Nominal Data (Optional: copy nom data to carriage for comparison later?)
                       // For now we just verify existence.
                       // Also load tolerances if we want them locally
                       "KetteLaufwagenDB".Station2.nXbreiteRechts := "MaximalkonturDB".Articles[#tempIndex].nXbreiteRechts;
                       "KetteLaufwagenDB".Station2.nXbreitelinks := "MaximalkonturDB".Articles[#tempIndex].nXbreitelinks;
                       "KetteLaufwagenDB".Station2.nYlaenge := "MaximalkonturDB".Articles[#tempIndex].nYlaenge;
                       "KetteLaufwagenDB".Station2.nTolX := "MaximalkonturDB".Articles[#tempIndex].nTolX;
                       "KetteLaufwagenDB".Station2.nTolY := "MaximalkonturDB".Articles[#tempIndex].nTolY;
                       
                       EXIT; 
                   END_IF;
               END_FOR;
               
               IF #bFound THEN
                   #step_St2 := 10; // Found, Continue
               ELSE
                   #step_St2 := 20; // Not Found, Stop & Inform
               END_IF;
           END_IF;
           
       10: // 4.1 Found - Ready to pass to St3
            // Waiting for physical transport... (Handled by conveyor logic outside, we assume flow continues)
            ;
            
       20: // 4.2 Not Found - Operator Action
           // Set lights handled in Output Signal Section
           IF #trig_BtnGreen.Q THEN // 4.2.1 Operator confirms
               "KetteLaufwagenDB".Station2.bIsNewArticle := TRUE;
               #step_St2 := 10; // Continue
           END_IF;
   END_CASE;

   // =============================================================
   // STATION 3: Measurement
   // =============================================================
   // Step 5: Arrival St3
   IF #trig_St3_Arr.Q THEN
       "KetteLaufwagenDB".Station3 := "KetteLaufwagenDB".Station2;
       "KetteLaufwagenDB".Station2.nArticleNumber := 0;
       "KetteLaufwagenDB".Station2.bIsNewArticle := FALSE;
       #step_St3 := 0;
   END_IF;
   
   // Step 6: Measurement Logic
   CASE #step_St3 OF
       0: // Wait for Measurement Start Trigger
           IF "KetteLaufwagenDB".Station3.nArticleNumber > 0 AND #trig_MeasStart.Q THEN
               #step_St3 := 10;
           END_IF;
           
       10: // Measuring (Simulated duration or instant)
           // 6. Output bLightGreen = flashing (handled below)
           
           // Capture Values (In reality this might take time/integration)
           "KetteLaufwagenDB".Station3.nActXbreiteRechts := #i_Meas_X_Right;
           "KetteLaufwagenDB".Station3.nActXbreitelinks := #i_Meas_X_Left;
           "KetteLaufwagenDB".Station3.nActYlaenge := #i_Meas_Y_Vertical;
           
           #step_St3 := 20; // Analyze
           
       20: // Analyze Data
           IF "KetteLaufwagenDB".Station3.bIsNewArticle THEN
               // 6.1 New Article Logic
               // 6.1.1 Find free slot
               FOR #tempIndex := 1 TO 999 DO
                   IF "MaximalkonturDB".Articles[#tempIndex].nArticleNumber = 0 THEN
                       // 6.1.2 / 6.1.3 Store Data
                       "MaximalkonturDB".Articles[#tempIndex].nArticleNumber := "KetteLaufwagenDB".Station3.nArticleNumber;
                       "MaximalkonturDB".Articles[#tempIndex].nXbreiteRechts := "KetteLaufwagenDB".Station3.nActXbreiteRechts;
                       "MaximalkonturDB".Articles[#tempIndex].nXbreitelinks := "KetteLaufwagenDB".Station3.nActXbreitelinks;
                       "MaximalkonturDB".Articles[#tempIndex].nYlaenge := "KetteLaufwagenDB".Station3.nActYlaenge;
                       
                       // 6.1.4 Reset Flag
                       "KetteLaufwagenDB".Station3.bIsNewArticle := FALSE;
                       #step_St3 := 30; // OK
                       EXIT;
                   END_IF;
               END_FOR;
               
           ELSE
               // 6.2 Existing Article Logic
               // Compare Actual vs Nominal +/- Tolerance
               // Nominal
               // Note: We already loaded nominals in St2 into the Carriage Struct for convenience, 
               // or we could look up again. Using St2 cached data in St3 struct:
               
               // Verification Logic (Simplified Abs Tolerance)
               // Check X Right
               IF ABS("KetteLaufwagenDB".Station3.nActXbreiteRechts - "KetteLaufwagenDB".Station3.nXbreiteRechts) > "KetteLaufwagenDB".Station3.nTolX OR
                  ABS("KetteLaufwagenDB".Station3.nActXbreitelinks - "KetteLaufwagenDB".Station3.nXbreitelinks) > "KetteLaufwagenDB".Station3.nTolX OR
                  ABS("KetteLaufwagenDB".Station3.nActYlaenge - "KetteLaufwagenDB".Station3.nYlaenge) > "KetteLaufwagenDB".Station3.nTolY THEN
                   
                   // Deviation detected
                   #step_St3 := 40; // Error State
               ELSE
                   // OK
                   #step_St3 := 30; // Passthrough
               END_IF;
           END_IF;
           
       30: // 6.2.4 Contour OK
           // Copy to Station 4 (Handover)
           "KetteLaufwagenDB".Station4 := "KetteLaufwagenDB".Station3; 
           "KetteLaufwagenDB".Station3.nArticleNumber := 0; // Clear St3
           
           // Robot Handover Outputs
           #bPrgrReadyForRobot := TRUE;
           #nPrgrNr_Robot := "KetteLaufwagenDB".Station4.nArticleNumber;
           
           #step_St3 := 99; // Done for this cycle
           
       40: // 6.2.3 Deviation / Error Detected
           // Lights handled in Output section
           
           // 5 sec Hold check for Green Button (Correction)
           #timer_Teach(IN := #bBtnGreen, PT := T#5S);
           
           IF #timer_Teach.Q THEN // 6.2.3.1 Operator overwrites/teaches
               // Update DB with NEW values? Or just accept?
               // Requirement say "Messung wird durch Bediener korrigiert" -> proceed to OK
               // Often requires updating the Master DB. Assuming just Accept for flow:
                #step_St3 := 30; // Go to OK
           END_IF;
           
           IF #trig_BtnRed.Q THEN // 6.2.3.2 Reject
               #step_St3 := 50; // Reject State
           END_IF;
           
       50: // 6.2.5 Contour NOK
           // Block Robot
           #bPrgrReadyForRobot := FALSE;
           #nPrgrNr_Robot := 999;
           // Stay here until reset? Or move out? 
           // Usually move to reject lane. For this FB, we hold state or clear.
           // Requirement: "Starte Funktionsbaustein fǬr Schrittkette RoboterǬbergabe" -> Done via outputs
           
           // If moved out (Simulated):
           // "KetteLaufwagenDB".Station3.nArticleNumber := 0;
           // #step_St3 := 0;
   END_CASE;

   // =============================================================
   // OUTPUT SIGNAL MAPPING
   // =============================================================
   
   // Defaults
   #bLightRed := FALSE;
   #bLightGreen := FALSE;
   #bHornAlarm := FALSE;

   // Station 2: New Article / Unknown
   IF #step_St2 = 20 THEN
       #bLightRed := TRUE;
       #bLightGreen := TRUE; // Both True = Operator Check Req (4.2)
   END_IF;

   // Station 3: Measuring
   IF #step_St3 = 10 THEN
       #bLightGreen := #bFlash; // Flashing Green
   END_IF;
   
   // Station 3: Error / Deviation (Step 6.2.3)
   IF #step_St3 = 40 THEN
       #bLightRed := #bFlash;
       #bHornAlarm := TRUE;
   END_IF;
   
   // Station 3: OK (Step 6.2.4) - Pulse or Steady?
   // "bLightGreen = TRUE"
   IF #step_St3 = 30 OR #step_St3 = 99 THEN
       #bLightGreen := TRUE;
   END_IF;
   
   // Station 3: NOK (Step 6.2.5)
   IF #step_St3 = 50 THEN
       #bLightRed := #bFlash; // "flasching TRUE"
       #bHornAlarm := #bFlash; 
   END_IF;

END_FUNCTION_BLOCK
