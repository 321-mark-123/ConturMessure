<ProcessFlow>
    <Description>Detaillierter Ablauf der Schrittkette fǬr das Konturmesssystem.</Description>
    
    <Architecture>
        <Principle>Modular Design</Principle>
        <Rule>Logic resides INSIDE Station FBs. Main Chain only calls FBs.</Rule>
        <Rule>Output Signals (Lights, Horns) are combined in Main Chain (OR-Logic). Station FBs provide status requests (e.g., bReq_RedLight).</Rule>
    </Architecture>

    <GlobalReset>
        <Name>StepInit</Name>
        <Condition>bBtnGreen AND bBtnRed (beide TRUE fǬr > 5 Sekunden)</Condition>
        <Action>Alle Stationsdaten in "KetteLaufwagenDB" werden gelscht (Reset). sStateDesc gesetzt auf "RESET".</Action>
    </GlobalReset>

    <Station1>
        <Description>Einlauf & DatenǬbernahme</Description>
        <Step2>
            <Input>b_inPrgrNr (BOOL) von S7-1200</Input>
            <Action>
                - Empfange n_inPrgrNr_Data (Programmnummer) und n_inLaufWgNr_Data.
                - Speichere Daten in "KetteLaufwagenDB.Station1".
                - Setze DataValid = TRUE.
                - Setze sStateDesc = "DATA_STORED".
            </Action>
            <Output>b_outPrgrNr_Ack = TRUE (Handshake)</Output>
        </Step2>
    </Station1>

    <Station2>
        <Description>PrǬfung & Teach-In</Description>
        <Logic>
            - Daten werden beim Transport von Station 1 nach Station 2 geschoben.
            - Suche im "MaximalkonturDB.Progr" (Loop 0..999) nach 'nProgrNumber'.
        </Logic>
        <Case_Found>
            - Wenn gefunden (sStateDesc="SEARCH_FOUND"): Kopiere Soll-Werte und Toleranzen.
            - Weiter zu Station 3.
        </Case_Found>
        <Case_NotFound>
            - Wenn NICHT gefunden (sStateDesc="SEARCH_NOT_FOUND"):
            - Output: Request Red Light + Request Green Light.
            - Warte auf Bediener (bBtnGreen, sStateDesc="WAIT_TEACH_IN").
            - Bei Tastendruck: Setze bIsNewArticle = TRUE (sStateDesc="TEACH_IN_CONFIRMED").
            - Weiter zu Station 3.
        </Case_NotFound>
    </Station2>

    <Station3>
        <Description>Messung & Auswertung</Description>
        <Logic>
            - Daten von Station 2 nach Station 3.
            - Warte auf 'bIniMessungStart'.
            - FǬhre Messung durch (Simulation: obernahme Input-Werte).
        </Logic>
        
        <Branch_NewArticle>
            <Condition>bIsNewArticle == TRUE</Condition>
            <Action>
                - Suche freien Slot im DB (Loop 0..999, wo nProgrNumber == 0).
                - Speichere gemessene Werte an diesem Index.
                - Aktualisiere nProgrNumber im Laufwagen-Datensatz.
                - Setze bIsNewArticle = FALSE.
                - Ergebnis: OK (sStateDesc="NEW_ARTICLE_SAVED").
            </Action>
        </Branch_NewArticle>

        <Branch_ExistingArticle>
            <Condition>bIsNewArticle == FALSE</Condition>
            <Step7.2.1>
                <Action>Suche Datensatz im DB Ǭber nProgrNumber (Loop).</Action>
                <Error>Nicht gefunden -> Alarm (sStateDesc="ERROR_PRGR_NOT_FOUND").</Error>
            </Step7.2.1>
            <Step7.2.2>
                <Action>Vergleiche Ist-Werter mit Soll-Werten (inkl. Toleranzen).</Action>
            </Step7.2.2>
            <Result_OK>
                - Request Green Light = TRUE.
                - bPrgrReadyForRobot = TRUE.
                - Output nPrgrNr_ToRobot = nProgrNumber.
                - sStateDesc="DONE_READY_TO_MOVE".
            </Result_OK>
            <Result_Error>
                - Abweichung erkannt -> Request Red Light (Flash) + Request Horn (Flash).
                - Operator Choice:
                    - bBtnGreen (> 5s): Akzeptieren -> OK.
                    - bBtnRed: Ablehnen -> NOK.
            </Result_Error>
            <Result_NOK>
                - bPrgrReadyForRobot = FALSE.
                - Output nPrgrNr_ToRobot = 999.
                - Request Red Light (Flash), Request Horn (Flash).
                - sStateDesc="REJECTED_BY_OPERATOR" (if Red pressed).
            </Result_NOK>
        </Branch_ExistingArticle>
    </Station3>

    <Station4>
        <Description>obergabe an Roboter</Description>
        <Action>
            - Daten von Station 3 nach Station 4.
            - Bereitstellung der Signale 'bPrgrReadyForRobot' und 'nPrgrNr_Robot'.
        </Action>
    </Station4>
</ProcessFlow>
